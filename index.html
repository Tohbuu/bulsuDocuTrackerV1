<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Document Portal</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="bulsuLogo.png" type="image/png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <header>
      <img src="bulsuLogo.png" alt="BulSU Logo" height="75px" />
      <h2 id="title">BulSU Document Tracker</h2>
      <button class="tab-btn active" data-tab="login" id="loginTabBtn">Login</button>
      <button class="tab-btn" data-tab="send" id="sendTabBtn" disabled>Send Documents</button>
      <button class="tab-btn" data-tab="receive" id="receiveTabBtn" disabled>Receive Documents</button>
      <button class="tab-btn" data-tab="track" id="trackTabBtn" disabled>Track Documents</button>
      <button class="tab-btn" data-tab="about">About Developer</button>
      <button class="tab-btn" data-tab="admin" id="adminTabBtn" disabled style="display:none;">Admin</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
    </header>

    <main>
      <!-- LOGIN -->
      <section id="login" class="tab active portal-section">
        <div class="portal-section-content">
          <h1 class="portal-section-title">Office Login</h1>
          <form id="portalForm-login">
            <div class="form-group">
              <label for="loginUsername">Username</label>
              <input type="text" id="loginUsername" name="username" required />
            </div>
            <div class="form-group">
              <label for="loginPassword">Password</label>
              <input type="password" id="loginPassword" name="password" required />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-primary">Login</button>
            </div>
          </form>
        </div>
      </section>

      <!-- SEND -->
      <section id="send" class="tab portal-section">
        <div class="portal-section-content">
          <h1 class="portal-section-title">Send Documents</h1>

          <form id="portalForm-send">
            <div class="form-group">
              <label for="sendDocName">Document Name / Nature of Communication:</label>
              <input type="text" id="sendDocName" name="docName" required />
            </div>

            <div class="form-group">
              <label for="sendReferringTo">Referring To:</label>
              <input type="text" id="sendReferringTo" name="referringTo" />
            </div>

            <div class="form-group">
              <label>Type of Communication:</label>
              <div class="radio-group">
                <label>
                  <input type="radio" name="docType" value="Internal Communication" required />
                  Internal Communication
                </label>
                <label>
                  <input type="radio" name="docType" value="External Communication" />
                  External Communication
                </label>
              </div>
            </div>

            <div class="form-group">
              <label for="receiverUsernameSend">Receiver Office Username:</label>
              <input type="text" id="receiverUsernameSend" name="receiverUsername" required />
            </div>

            <input type="hidden" id="docTagInput" name="docTag" />

            <div class="form-actions" style="display:flex; gap:8px; align-items:center">
              <button type="button" class="btn-primary" id="generateBtn">Generate Tag & QR</button>
              <button type="button" id="resetSendBtn">Reset</button>
              <button type="submit" class="btn-primary" id="sendSubmitBtn">Submit</button>
            </div>

            <div id="generatedArea" style="margin-top:16px; display:none; gap:12px; align-items:center">
              <div id="qrContainer" style="display:flex; flex-direction:column; align-items:center">
                <img
                  id="qrImage"
                  alt="QR Code"
                  style="width:150px; height:150px; border:1px solid #ccc; border-radius:6px"
                />
                <small>Scan to open document tag</small>
              </div>
              <div id="tagContainer" style="display:flex; flex-direction:column; justify-content:center">
                <label style="font-weight:bold; margin-bottom:6px">Document Tag</label>
                <div
                  id="docTag"
                  style="font-family:monospace; background:#f4f4f4; padding:8px 10px; border-radius:4px; border:1px solid #ddd"
                ></div>
                <div style="margin-top:8px; display:flex; gap:8px">
                  <button type="button" id="copyTagBtn">Copy Tag</button>
                  <button type="button" id="printQrBtn">Print QR on Letter</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </section>

      <!-- RECEIVE -->
      <section id="receive" class="tab portal-section">
        <div class="portal-section-content">
          <h1 class="portal-section-title">Receive Documents</h1>
          <form id="portalForm-receive">
            <div class="form-group">
              <label for="receiveFileID">Unique File ID</label>
              <input type="text" id="receiveFileID" name="fileID" required />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-primary">Mark as Received</button>
            </div>
          </form>
        </div>
      </section>

      <!-- TRACK -->
      <section id="track" class="tab portal-section">
        <div class="portal-section-content">
          <h1 class="portal-section-title">Track Documents</h1>
          <form id="portalForm-track">
            <div class="form-group">
              <label for="fileID">Unique File ID:</label>
              <input type="text" id="fileID" name="fileID" required />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-primary">Track</button>
            </div>
          </form>
        </div>
      </section>

      <!-- ABOUT -->
      <section id="about" class="tab portal-section">
        <h1>About the Developer</h1>
        <img src="dom.png" id="domImage" alt="Developer Photo" />
        <h1>Full-Stack Developer</h1>
        <p>Developed by Larence Dominic T. Sto. Tomas, in compliance to Elective 1.</p>
      </section>

      <!-- ADMIN -->
      <section id="admin" class="tab portal-section">
        <div class="portal-section-content">
          <h1 class="portal-section-title">Admin</h1>

          <h2 style="margin: 12px 0; color:#333; font-size:1.2rem; text-align:left;">Create Office Account</h2>
          <form id="portalForm-admin-create">
            <div class="form-group">
              <label for="adminNewUsername">New Username</label>
              <input type="text" id="adminNewUsername" name="username" required />
            </div>

            <div class="form-group">
              <label for="adminNewPassword">New Password</label>
              <input type="password" id="adminNewPassword" name="password" required />
            </div>

            <div class="form-group">
              <label style="display:flex; gap:.5rem; align-items:center; font-weight:600;">
                <input type="checkbox" name="isAdmin" value="1" />
                Make this account an admin
              </label>
            </div>

            <div class="form-actions" style="display:flex; gap:8px; align-items:center; justify-content:center;">
              <button type="submit" class="btn-primary">Create Account</button>
            </div>
          </form>

          <hr style="margin: 18px 0; border:0; border-top:1px solid #eee;" />

          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <h2 style="margin: 0; color:#333; font-size:1.2rem; text-align:left;">Existing Offices</h2>
            <button type="button" id="adminRefreshBtn">Refresh</button>
          </div>

          <div style="margin-top:12px; overflow:auto; max-height:260px; border:1px solid #eee; border-radius:8px;">
            <table id="adminOfficesTable" style="width:100%; border-collapse:collapse; font-size:.95rem;">
              <thead>
                <tr style="background:#f7f7f7;">
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #eee;">Username</th>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #eee;">Role</th>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #eee;">Created</th>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #eee;">Actions</th>
                </tr>
              </thead>
              <tbody id="adminOfficesTbody">
                <tr><td colspan="4" style="padding:10px; color:#666;">Click Refresh to load.</td></tr>
              </tbody>
            </table>
          </div>

          <h2 style="margin: 18px 0 10px; color:#333; font-size:1.2rem; text-align:left;">Reset Password</h2>
          <form id="portalForm-admin-reset">
            <div class="form-group">
              <label for="adminResetUsername">Username</label>
              <input type="text" id="adminResetUsername" name="username" required />
            </div>
            <div class="form-group">
              <label for="adminResetPassword">New Password</label>
              <input type="password" id="adminResetPassword" name="newPassword" required />
            </div>
            <div class="form-actions" style="display:flex; gap:8px; align-items:center; justify-content:center;">
              <button type="submit" class="btn-primary">Update Password</button>
            </div>
          </form>
        </div>
      </section>
    </main>

    <div id="popup" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%);
      background:#333; color:#fff; padding:16px 24px; border-radius:5px; z-index:1000; font-weight:bold;
      box-shadow:0 0 10px rgba(0,0,0,0.5);"></div>

    <script>
      const buttons = document.querySelectorAll(".tab-btn");
      const tabs = document.querySelectorAll(".tab");

      function showPopup(message, isSuccess = true) {
        const popup = document.getElementById("popup");
        popup.textContent = message;
        popup.style.background = isSuccess ? "#333" : "#b22222";
        popup.style.display = "block";
        setTimeout(() => (popup.style.display = "none"), 3000);
      }

      function activateTab(tabId) {
        buttons.forEach((b) => b.classList.remove("active"));
        tabs.forEach((t) => t.classList.remove("active"));

        const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
        const tab = document.getElementById(tabId);
        if (btn) btn.classList.add("active");
        if (tab) tab.classList.add("active");
      }

      function setAuthedUI(isAuthed, isAdmin = false) {
        document.getElementById("sendTabBtn").disabled = !isAuthed;
        document.getElementById("receiveTabBtn").disabled = !isAuthed;
        document.getElementById("trackTabBtn").disabled = !isAuthed;

        const adminBtn = document.getElementById("adminTabBtn");
        adminBtn.disabled = !(isAuthed && isAdmin);
        adminBtn.style.display = (isAuthed && isAdmin) ? "" : "none";

        document.getElementById("loginTabBtn").style.display = isAuthed ? "none" : "";
        document.getElementById("logoutBtn").style.display = isAuthed ? "" : "none";

        if (isAuthed) activateTab("send");
        else activateTab("login");
      }

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          if (btn.disabled) return;
          activateTab(btn.getAttribute("data-tab"));
        });
      });

      // Tag/QR generator (kept)
      (function () {
        const generateBtn = document.getElementById("generateBtn");
        const resetBtn = document.getElementById("resetSendBtn");
        const qrImage = document.getElementById("qrImage");
        const docTagDiv = document.getElementById("docTag");
        const docTagInput = document.getElementById("docTagInput");
        const generatedArea = document.getElementById("generatedArea");
        const copyBtn = document.getElementById("copyTagBtn");
        const printBtn = document.getElementById("printQrBtn");

        function makeTag() {
          const ts = Date.now().toString(36).toUpperCase();
          const rnd = Math.random().toString(36).slice(2, 8).toUpperCase();
          return `BULSU-${ts}-${rnd}`;
        }

        function setQRfor(tag) {
          const data = encodeURIComponent(tag);
          qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${data}`;
        }

        generateBtn.addEventListener("click", function () {
          const tag = makeTag();
          docTagDiv.textContent = tag;
          docTagInput.value = tag;
          setQRfor(tag);
          generatedArea.style.display = "flex";
        });

        resetBtn.addEventListener("click", function () {
          docTagDiv.textContent = "";
          docTagInput.value = "";
          qrImage.src = "";
          generatedArea.style.display = "none";
          document.getElementById("portalForm-send").reset();
        });

        copyBtn.addEventListener("click", function () {
          const tag = docTagInput.value;
          if (!tag) return;
          navigator.clipboard?.writeText(tag).then(() => {
            copyBtn.textContent = "Copied";
            setTimeout(() => (copyBtn.textContent = "Copy Tag"), 1200);
          });
        });

        printBtn.addEventListener("click", function () {
          const tag = docTagInput.value;
          const src = qrImage.src;
          if (!tag || !src) return;

          const printHtml = `
            <!doctype html>
            <html><head><meta charset="utf-8"><title>Print QR - ${tag}</title>
            <style>
              @page { size: 8.5in 11in; margin: 0.5in; }
              html,body { height:100%; margin:0; padding:0; }
              body { display:flex; align-items:center; justify-content:center; font-family: Arial, sans-serif; }
              .sheet { width:100%; height:100%; box-sizing:border-box; display:flex; flex-direction:column; align-items:center; justify-content:center; }
              .qr { width:300px; height:300px; }
              .tag { font-family: monospace; margin-top:16px; font-size:18px; word-break:break-all; }
            </style></head>
            <body><div class="sheet">
              <img class="qr" src="${src}" alt="QR">
              <div class="tag">${tag}</div>
            </div></body></html>
          `;

          const w = window.open("", "_blank");
          if (!w) return alert("Popup blocked. Allow popups to print.");
          w.document.open();
          w.document.write(printHtml);
          w.document.close();
          w.focus();
          setTimeout(() => w.print(), 600);
        });
      })();

      async function postForm(endpoint, form) {
        const formData = new FormData(form);
        const res = await fetch(endpoint, { method: "POST", body: formData });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || "Request failed");
        return data;
      }

      document.getElementById("portalForm-login").addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
          const data = await postForm("login.php", e.target);
          showPopup(data.message || "Logged in.", true);
          setAuthedUI(true, Boolean(data?.data?.isAdmin));
        } catch (err) {
          showPopup(err.message || "Login failed.", false);
        }
      });

      document.getElementById("logoutBtn").addEventListener("click", async () => {
        try {
          const res = await fetch("logout.php", { method: "POST" });
          const data = await res.json().catch(() => ({}));
          showPopup(data.message || "Logged out.", true);
        } finally {
          setAuthedUI(false, false);
        }
      });

      document.getElementById("portalForm-send").addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
          const data = await postForm("documentSend.php", e.target);
          showPopup(`Saved. File ID: ${data.data?.fileId || ""}`, true);
        } catch (err) {
          showPopup(err.message || "Send failed.", false);
        }
      });

      document.getElementById("portalForm-receive").addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
          const data = await postForm("documentReceive.php", e.target);
          showPopup(data.message || "Received.", true);
        } catch (err) {
          showPopup(err.message || "Receive failed.", false);
        }
      });

      document.getElementById("portalForm-track").addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
          const data = await postForm("trackDocument.php", e.target);
          showPopup(`${data.data?.status || "OK"}: ${data.data?.documentName || ""}`, true);
        } catch (err) {
          showPopup(err.message || "Track failed.", false);
        }
      });

      document.getElementById("portalForm-admin-create").addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
          const data = await postForm("adminCreateOffice.php", e.target);
          showPopup(data.message || "Created.", true);
          e.target.reset();
        } catch (err) {
          showPopup(err.message || "Create failed.", false);
        }
      });

      async function loadOffices() {
        const tbody = document.getElementById("adminOfficesTbody");
        tbody.innerHTML = `<tr><td colspan="4" style="padding:10px; color:#666;">Loading...</td></tr>`;

        try {
          const res = await fetch("adminListOffices.php");
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.message || "Failed to load offices.");

          const offices = data?.data?.offices || [];
          if (!offices.length) {
            tbody.innerHTML = `<tr><td colspan="4" style="padding:10px; color:#666;">No offices found.</td></tr>`;
            return;
          }

          tbody.innerHTML = offices
            .map((o) => {
              const role = o.isAdmin ? "Admin" : "Office";
              const toggleLabel = o.isAdmin ? "Demote" : "Promote";
              const toggleTo = o.isAdmin ? "0" : "1";

              return `
                <tr>
                  <td style="padding:10px; border-bottom:1px solid #eee; font-family:monospace;">${o.username}</td>
                  <td style="padding:10px; border-bottom:1px solid #eee;">${role}</td>
                  <td style="padding:10px; border-bottom:1px solid #eee;">${o.createdAt}</td>
                  <td style="padding:10px; border-bottom:1px solid #eee; white-space:nowrap;">
                    <button type="button"
                            class="admin-action-btn"
                            data-action="toggle"
                            data-username="${o.username}"
                            data-isadmin="${toggleTo}">
                      ${toggleLabel}
                    </button>
                    <button type="button"
                            class="admin-action-btn"
                            data-action="delete"
                            data-username="${o.username}">
                      Delete
                    </button>
                  </td>
                </tr>
              `;
            })
            .join("");

          // bind action buttons
          tbody.querySelectorAll(".admin-action-btn").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const action = btn.getAttribute("data-action");
              const username = btn.getAttribute("data-username");

              if (action === "toggle") {
                const isAdmin = btn.getAttribute("data-isadmin");
                const ok = confirm(`Change admin role for "${username}"?`);
                if (!ok) return;

                const form = new FormData();
                form.append("username", username);
                form.append("isAdmin", isAdmin);

                try {
                  const res = await fetch("adminSetRole.php", { method: "POST", body: form });
                  const data = await res.json().catch(() => ({}));
                  if (!res.ok) throw new Error(data.message || "Failed to update role.");
                  showPopup(data.message || "Role updated.", true);
                  await loadOffices();
                } catch (err) {
                  showPopup(err.message || "Role update failed.", false);
                }
              }

              if (action === "delete") {
                const ok = confirm(`Delete office "${username}"? This cannot be undone.`);
                if (!ok) return;

                const form = new FormData();
                form.append("username", username);

                try {
                  const res = await fetch("adminDeleteOffice.php", { method: "POST", body: form });
                  const data = await res.json().catch(() => ({}));
                  if (!res.ok) throw new Error(data.message || "Failed to delete office.");
                  showPopup(data.message || "Office deleted.", true);
                  await loadOffices();
                } catch (err) {
                  showPopup(err.message || "Delete failed.", false);
                }
              }
            });
          });
        } catch (err) {
          tbody.innerHTML = `<tr><td colspan="4" style="padding:10px; color:#b22222;">${err.message || "Error"}</td></tr>`;
        }
      }

      document.getElementById("adminRefreshBtn").addEventListener("click", async () => {
        await loadOffices();
      });

      document.getElementById("portalForm-admin-reset").addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
          const data = await postForm("adminResetPassword.php", e.target);
          showPopup(data.message || "Password updated.", true);
          e.target.reset();
        } catch (err) {
          showPopup(err.message || "Reset failed.", false);
        }
      });

      // Optional: auto-load offices whenever Admin tab is opened
      document.getElementById("adminTabBtn").addEventListener("click", () => {
        loadOffices();
      });

      // initial session check
      (async function () {
        try {
          const res = await fetch("me.php");
          const data = await res.json();
          setAuthedUI(Boolean(data?.data?.loggedIn), Boolean(data?.data?.isAdmin));
        } catch {
          setAuthedUI(false, false);
        }
      })();
    </script>
  </body>
</html>
